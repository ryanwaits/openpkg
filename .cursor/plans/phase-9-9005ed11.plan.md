<!-- 9005ed11-7c77-4436-bb2e-85da07fc8d32 728bf5b2-214e-4e3b-84c6-a7947a73d2a0 -->
# Phase 9: Docs Impact Analysis (Diff-Driven)

## Vision

When code changes, automatically detect which documentation files are impacted and need updates. The spec diff drives everything - markdown files are targets of analysis, not sources.

**Example output:**

```
$ doccov diff base.json head.json --docs "docs/**/*.md"

Spec Changes:
  Breaking: updateChainhook() signature changed (+network param)
  Breaking: legacyWebhook() removed
  NonBreaking: createWebhook() added

Docs Impact:
  ðŸ“„ docs/guides/chainhooks-setup.md
     Line 45: updateChainhook(id) needs network param
     Line 78: updateChainhook(id) needs network param
  
  ðŸ“„ docs/guides/webhook-migration.md
     Line 23: legacyWebhook() is deprecated â†’ use createWebhook()
  
  ðŸ“„ docs/reference/webhooks.md
     Missing: No docs for new createWebhook() export

Exit 1 (3 files need updates)
```

---

## Architecture

| Component | Responsibility |

|-----------|----------------|

| SDK markdown parser | Extract code blocks, find export references |

| Spec diff engine | Identify what changed between versions (exists) |

| AI impact analyzer | Deep semantic understanding of doc structure |

| CLI `--docs` flag | Wire it together with reporting |

| GitHub Action | CI integration with PR comments |

---

## Phase 9.1: SDK Markdown Parser

**Files:** `packages/sdk/src/markdown/parser.ts`, `packages/sdk/src/markdown/types.ts`

**Dependencies:** `unified`, `remark-parse`, `remark-mdx`, `unist-util-visit`

### Types

```typescript
export interface MarkdownCodeBlock {
  lang: string;
  code: string;
  lineStart: number;
  lineEnd: number;
}

export interface MarkdownDocFile {
  path: string;
  codeBlocks: MarkdownCodeBlock[];
}

export interface ExportReference {
  exportName: string;
  file: string;
  line: number;
  context: string;  // surrounding code/text
  inCodeBlock: boolean;
}

export interface DocsImpact {
  file: string;
  references: Array<{
    exportName: string;
    line: number;
    changeType: 'signature-changed' | 'removed' | 'deprecated';
    suggestion?: string;
  }>;
}

export interface DocsImpactResult {
  impactedFiles: DocsImpact[];
  missingDocs: string[];  // new exports with no docs
  stats: {
    filesScanned: number;
    referencesFound: number;
    impactedReferences: number;
  };
}
```

### Functions

```typescript
// Parse markdown files to extract code blocks
export function parseMarkdownFile(content: string, path: string): MarkdownDocFile;

// Find all references to given export names in markdown files
export function findExportReferences(
  files: MarkdownDocFile[],
  exportNames: string[]
): ExportReference[];
```

---

## Phase 9.2: Extend SpecDiff with Docs Impact

**File:** `packages/spec/src/diff.ts`

Extend existing `diffSpec()` or add new function:

```typescript
export interface SpecDiffWithDocs extends SpecDiff {
  docsImpact?: DocsImpactResult;
}

export function diffSpecWithDocs(
  oldSpec: OpenPkg,
  newSpec: OpenPkg,
  markdownFiles: MarkdownDocFile[]
): SpecDiffWithDocs;
```

### Logic

1. Get changed exports from existing `diffSpec()`
2. For each breaking change, find markdown references
3. For each new export, check if docs exist
4. Return combined result

---

## Phase 9.3: CLI `--docs` Flag for Diff Command

**File:** `packages/cli/src/commands/diff.ts`

### Usage

```bash
# Basic diff (existing)
doccov diff base.json head.json

# With docs impact analysis
doccov diff base.json head.json --docs "docs/**/*.md"

# Multiple globs
doccov diff base.json head.json --docs "docs/**/*.md" --docs "README.md"
```

### Implementation

1. Parse `--docs` glob patterns
2. Read and parse markdown files with SDK
3. Call `diffSpecWithDocs()` instead of `diffSpec()`
4. Enhanced output with docs impact section
5. Exit 1 if impacted files found (CI fail)

---

## Phase 9.4: AI-Powered Deep Analysis

**File:** `packages/cli/src/utils/docs-impact-ai.ts`

Three levels of analysis:

| Level | What | When |

|-------|------|------|

| L1: Grep | Find export name mentions | Fast, always on |

| L2: Parse | Analyze code block usage patterns | `--docs` flag |

| L3: Semantic | Understand tutorial flow, suggest fixes | `--ai` flag |

### AI Functions

```typescript
// Analyze how a code block uses an export
export async function analyzeCodeBlockUsage(
  block: MarkdownCodeBlock,
  changedExport: string,
  changeDetails: { oldSignature: string; newSignature: string }
): Promise<{
  isImpacted: boolean;
  reason: string;
  suggestedFix?: string;
}>;

// Generate fix for impacted reference
export async function generateDocFix(
  file: string,
  impact: DocsImpact,
  spec: OpenPkg
): Promise<{
  patch: string;  // Diff to apply
  explanation: string;
}>;
```

---

## Phase 9.5: GitHub Action Integration

**File:** `action.yml` (extend existing)

### New Inputs

```yaml
inputs:
  docs-glob:
    description: 'Glob pattern for markdown docs to check'
    required: false
    default: ''
  fail-on-docs-impact:
    description: 'Fail if docs need updates'
    required: false
    default: 'true'
```

### PR Comment Format

```markdown
## ðŸ“š Documentation Impact

Your changes affect **3 documentation files**.

### Files Needing Updates

| File | Issues |
|------|--------|
| `docs/guides/setup.md` | 2 signature changes |
| `docs/guides/migration.md` | 1 deprecated reference |

### Missing Documentation

- `createWebhook()` - new export with no docs

<details>
<summary>View details</summary>

#### docs/guides/setup.md

- **Line 45**: `updateChainhook(id)` â†’ add `network` parameter
- **Line 78**: `updateChainhook(id)` â†’ add `network` parameter

</details>
```

---

## Phase 9.6: Config Integration (Optional)

**File:** `packages/cli/src/config/schema.ts`

```typescript
export interface DocCovConfig {
  // ... existing ...
  
  docs?: {
    include?: string[];  // ['docs/**/*.md', 'README.md']
    exclude?: string[];  // ['docs/archive/**']
  };
}
```

When `docs` is configured, `doccov diff` automatically includes docs impact (no `--docs` flag needed).

---

## Future: AI Fix PRs (Phase 9.7+)

```bash
# Generate fixes without applying
doccov docs fix --dry-run

# Apply fixes to files
doccov docs fix

# Create PR with fixes (CI)
doccov docs fix --create-pr
```

This is a later phase after the core impact detection works.

---

## Runtime Example Validation (Separate Feature)

Keep as separate future feature:

```bash
doccov docs validate --run  # Execute code blocks, check for errors
```

Building blocks exist in SDK (`runExamplesWithPackage()`), but this is orthogonal to impact analysis.

---

## Task Breakdown

| ID | Task | Priority | Effort |

|----|------|----------|--------|

| 9.1 | SDK markdown parser (remark-based) | P1 | Medium |

| 9.2 | SDK export reference finder | P1 | Medium |

| 9.3 | Extend diffSpec with docs impact | P1 | Low |

| 9.4 | CLI --docs flag for diff command | P1 | Medium |

| 9.5 | AI code block usage analyzer | P2 | Medium |

| 9.6 | AI fix suggestion generator | P2 | Medium |

| 9.7 | GitHub Action docs impact section | P2 | Low |

| 9.8 | Config-based docs paths | P3 | Low |

| 9.9 | AI-generated fix PRs | P3 | High |

### To-dos

- [ ] SDK markdown parser (types.ts, parser.ts) with remark
- [ ] CLI AI utils (markdown-ai.ts) with AI SDK
- [ ] CLI doccov docs command
- [ ] API docs-stream.ts SSE endpoint
- [ ] Import validation against spec exports
- [ ] AI fix suggestions for drift
- [ ] GitHub Action integration